<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AG Grid URL Sync - Multi-Grid Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>
    <script type="module">
      import { AGGridUrlSync } from '../dist/index.js'
      window.AGGridUrlSync = { AGGridUrlSync }
    </script>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }
      .header {
        background: #1976d2;
        color: white;
        padding: 20px;
        text-align: center;
      }
      .grid-section {
        margin: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
      }
      .grid-header {
        background: #f5f5f5;
        padding: 15px;
        border-bottom: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .grid-title {
        font-size: 18px;
        font-weight: bold;
        color: #333;
      }
      .grid-controls {
        display: flex;
        gap: 10px;
      }
      .btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }
      .btn-primary {
        background: #1976d2;
        color: white;
      }
      .btn-secondary {
        background: #f5f5f5;
        color: #333;
        border: 1px solid #ddd;
      }
      .btn-success {
        background: #388e3c;
        color: white;
      }
      .grid-container {
        height: 300px;
        width: 100%;
      }
      .controls-panel {
        padding: 20px;
        background: #fafafa;
        border-bottom: 1px solid #ddd;
      }
      .url-display {
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 12px;
        font-family: 'Courier New', monospace;
        font-size: 11px;
        word-break: break-all;
        margin: 10px 0;
        max-height: 100px;
        overflow-y: auto;
      }
      .status-bar {
        padding: 10px 20px;
        background: #e8f5e8;
        border-top: 1px solid #ddd;
        font-size: 12px;
        color: #2e7d32;
      }
      .grid-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px;
      }
      @media (max-width: 1000px) {
        .grid-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>🏢 Multi-Grid URL Sync Demo</h1>
        <p>Independent grids with separate URL namespacing</p>
      </div>

      <div class="controls-panel">
        <h3>🔗 Combined URL State</h3>
        <div class="grid-controls">
          <button class="btn btn-success" onclick="generateCombinedUrl()">
            📋 Generate Combined URL
          </button>
          <button class="btn btn-secondary" onclick="copyUrlToClipboard()">
            📄 Copy
          </button>
          <button class="btn btn-secondary" onclick="clearAllGrids()">
            🧹 Clear All Grids
          </button>
          <button class="btn btn-secondary" onclick="applySampleFilters()">
            🎯 Apply Sample Filters
          </button>
        </div>
        <div id="combinedUrlDisplay" class="url-display">
          No filters applied yet. Use the controls on individual grids or click
          "Apply Sample Filters" to see URL generation.
        </div>
      </div>

      <div class="grid-row">
        <div class="grid-section">
          <div class="grid-header">
            <div class="grid-title">👥 Employees Grid</div>
            <div class="grid-controls">
              <button
                class="btn btn-primary"
                onclick="filterEmployeesByDept('Engineering')"
              >
                ⚙️ Engineering
              </button>
              <button
                class="btn btn-primary"
                onclick="filterEmployeesByDept('Sales')"
              >
                💰 Sales
              </button>
              <button
                class="btn btn-secondary"
                onclick="clearEmployeesFilters()"
              >
                🧹 Clear
              </button>
            </div>
          </div>
          <div id="employeesGrid" class="grid-container ag-theme-alpine"></div>
        </div>

        <div class="grid-section">
          <div class="grid-header">
            <div class="grid-title">📊 Projects Grid</div>
            <div class="grid-controls">
              <button
                class="btn btn-primary"
                onclick="filterProjectsByStatus('Active')"
              >
                🟢 Active
              </button>
              <button
                class="btn btn-primary"
                onclick="filterProjectsByStatus('Completed')"
              >
                ✅ Completed
              </button>
              <button
                class="btn btn-secondary"
                onclick="clearProjectsFilters()"
              >
                🧹 Clear
              </button>
            </div>
          </div>
          <div id="projectsGrid" class="grid-container ag-theme-alpine"></div>
        </div>
      </div>

      <div class="grid-row">
        <div class="grid-section">
          <div class="grid-header">
            <div class="grid-title">🏢 Departments Grid</div>
            <div class="grid-controls">
              <button
                class="btn btn-primary"
                onclick="filterDepartmentsByLocation('West')"
              >
                🌅 West Coast
              </button>
              <button
                class="btn btn-primary"
                onclick="filterDepartmentsByLocation('East')"
              >
                🌆 East Coast
              </button>
              <button
                class="btn btn-secondary"
                onclick="clearDepartmentsFilters()"
              >
                🧹 Clear
              </button>
            </div>
          </div>
          <div
            id="departmentsGrid"
            class="grid-container ag-theme-alpine"
          ></div>
        </div>

        <div class="grid-section">
          <div class="grid-header">
            <div class="grid-title">📈 Metrics Grid</div>
            <div class="grid-controls">
              <button
                class="btn btn-primary"
                onclick="filterMetricsByType('Revenue')"
              >
                💵 Revenue
              </button>
              <button
                class="btn btn-primary"
                onclick="filterMetricsByType('Performance')"
              >
                📊 Performance
              </button>
              <button class="btn btn-secondary" onclick="clearMetricsFilters()">
                🧹 Clear
              </button>
            </div>
          </div>
          <div id="metricsGrid" class="grid-container ag-theme-alpine"></div>
        </div>
      </div>

      <div class="status-bar" id="statusBar">
        Ready. Load complete. All grids initialized.
      </div>
    </div>

    <script>
      // Sample data for different grids
      const employeesData = [
        {
          name: 'John Smith',
          department: 'Engineering',
          position: 'Senior Developer',
          location: 'San Francisco'
        },
        {
          name: 'Sarah Johnson',
          department: 'Sales',
          position: 'Account Manager',
          location: 'New York'
        },
        {
          name: 'Mike Chen',
          department: 'Engineering',
          position: 'Tech Lead',
          location: 'Seattle'
        },
        {
          name: 'Emily Davis',
          department: 'Marketing',
          position: 'Marketing Manager',
          location: 'Chicago'
        },
        {
          name: 'Robert Wilson',
          department: 'Sales',
          position: 'Sales Director',
          location: 'Boston'
        }
      ]

      const projectsData = [
        {
          name: 'Website Redesign',
          status: 'Active',
          team: 'Engineering',
          priority: 'High'
        },
        {
          name: 'Mobile App',
          status: 'Completed',
          team: 'Engineering',
          priority: 'Medium'
        },
        {
          name: 'Sales Campaign',
          status: 'Active',
          team: 'Marketing',
          priority: 'High'
        },
        {
          name: 'Customer Portal',
          status: 'Planning',
          team: 'Engineering',
          priority: 'Low'
        },
        {
          name: 'Market Research',
          status: 'Completed',
          team: 'Marketing',
          priority: 'Medium'
        }
      ]

      const departmentsData = [
        {
          name: 'Engineering',
          location: 'West Coast',
          headcount: 25,
          budget: 2500000
        },
        {
          name: 'Sales',
          location: 'East Coast',
          headcount: 15,
          budget: 1200000
        },
        {
          name: 'Marketing',
          location: 'West Coast',
          headcount: 8,
          budget: 800000
        },
        { name: 'HR', location: 'East Coast', headcount: 5, budget: 400000 }
      ]

      const metricsData = [
        { metric: 'Q1 Revenue', type: 'Revenue', value: 1250000, trend: 'Up' },
        {
          metric: 'Customer Satisfaction',
          type: 'Performance',
          value: 8.5,
          trend: 'Up'
        },
        { metric: 'Q2 Revenue', type: 'Revenue', value: 1380000, trend: 'Up' },
        {
          metric: 'Employee Retention',
          type: 'Performance',
          value: 92,
          trend: 'Stable'
        },
        { metric: 'Q3 Revenue', type: 'Revenue', value: 1420000, trend: 'Up' }
      ]

      // Grid APIs and URL sync instances
      let employeesGridApi, projectsGridApi, departmentsGridApi, metricsGridApi
      let employeesUrlSync, projectsUrlSync, departmentsUrlSync, metricsUrlSync

      document.addEventListener('DOMContentLoaded', function () {
        initializeGrids()

        setTimeout(() => {
          initializeUrlSync()
          applyUrlFiltersFromCurrentUrl()
        }, 200)
      })

      function initializeGrids() {
        // Employees Grid
        employeesGridApi = agGrid.createGrid(
          document.getElementById('employeesGrid'),
          {
            columnDefs: [
              {
                field: 'name',
                headerName: 'Name',
                filter: 'agTextColumnFilter',
                floatingFilter: true
              },
              {
                field: 'department',
                headerName: 'Department',
                filter: 'agTextColumnFilter',
                floatingFilter: true
              },
              {
                field: 'position',
                headerName: 'Position',
                filter: 'agTextColumnFilter',
                floatingFilter: true
              },
              {
                field: 'location',
                headerName: 'Location',
                filter: 'agTextColumnFilter',
                floatingFilter: true
              }
            ],
            rowData: employeesData,
            defaultColDef: { resizable: true, sortable: true, flex: 1 },
            onFilterChanged: updateStatusBar
          }
        )

        // Projects Grid
        projectsGridApi = agGrid.createGrid(
          document.getElementById('projectsGrid'),
          {
            columnDefs: [
              {
                field: 'name',
                headerName: 'Project',
                filter: 'agTextColumnFilter',
                floatingFilter: true
              },
              {
                field: 'status',
                headerName: 'Status',
                filter: 'agTextColumnFilter',
                floatingFilter: true
              },
              {
                field: 'team',
                headerName: 'Team',
                filter: 'agTextColumnFilter',
                floatingFilter: true
              },
              {
                field: 'priority',
                headerName: 'Priority',
                filter: 'agTextColumnFilter',
                floatingFilter: true
              }
            ],
            rowData: projectsData,
            defaultColDef: { resizable: true, sortable: true, flex: 1 },
            onFilterChanged: updateStatusBar
          }
        )

        // Departments Grid
        departmentsGridApi = agGrid.createGrid(
          document.getElementById('departmentsGrid'),
          {
            columnDefs: [
              {
                field: 'name',
                headerName: 'Department',
                filter: 'agTextColumnFilter',
                floatingFilter: true
              },
              {
                field: 'location',
                headerName: 'Location',
                filter: 'agTextColumnFilter',
                floatingFilter: true
              },
              {
                field: 'headcount',
                headerName: 'Headcount',
                filter: 'agNumberColumnFilter',
                floatingFilter: true
              },
              {
                field: 'budget',
                headerName: 'Budget',
                filter: 'agNumberColumnFilter',
                floatingFilter: true
              }
            ],
            rowData: departmentsData,
            defaultColDef: { resizable: true, sortable: true, flex: 1 },
            onFilterChanged: updateStatusBar
          }
        )

        // Metrics Grid
        metricsGridApi = agGrid.createGrid(
          document.getElementById('metricsGrid'),
          {
            columnDefs: [
              {
                field: 'metric',
                headerName: 'Metric',
                filter: 'agTextColumnFilter',
                floatingFilter: true
              },
              {
                field: 'type',
                headerName: 'Type',
                filter: 'agTextColumnFilter',
                floatingFilter: true
              },
              {
                field: 'value',
                headerName: 'Value',
                filter: 'agNumberColumnFilter',
                floatingFilter: true
              },
              {
                field: 'trend',
                headerName: 'Trend',
                filter: 'agTextColumnFilter',
                floatingFilter: true
              }
            ],
            rowData: metricsData,
            defaultColDef: { resizable: true, sortable: true, flex: 1 },
            onFilterChanged: updateStatusBar
          }
        )
      }

      function initializeUrlSync() {
        if (!window.AGGridUrlSync) return

        // Initialize URL sync for each grid with different prefixes
        employeesUrlSync = new window.AGGridUrlSync.AGGridUrlSync(
          employeesGridApi,
          {
            paramPrefix: 'emp_',
            onParseError: handleParseError
          }
        )

        projectsUrlSync = new window.AGGridUrlSync.AGGridUrlSync(
          projectsGridApi,
          {
            paramPrefix: 'proj_',
            onParseError: handleParseError
          }
        )

        departmentsUrlSync = new window.AGGridUrlSync.AGGridUrlSync(
          departmentsGridApi,
          {
            paramPrefix: 'dept_',
            onParseError: handleParseError
          }
        )

        metricsUrlSync = new window.AGGridUrlSync.AGGridUrlSync(
          metricsGridApi,
          {
            paramPrefix: 'metric_',
            onParseError: handleParseError
          }
        )

        updateStatusBar()
      }

      function handleParseError(error) {
        console.error('URL Parse Error:', error)
        updateStatusBar(`Error: ${error.message}`)
      }

      function updateStatusBar(message) {
        if (message) {
          document.getElementById('statusBar').textContent = message
          return
        }

        const totalFilters = getTotalActiveFilters()
        document.getElementById('statusBar').textContent =
          `Active filters across all grids: ${totalFilters}`
      }

      function getTotalActiveFilters() {
        let total = 0
        if (employeesGridApi)
          total += Object.keys(employeesGridApi.getFilterModel()).length
        if (projectsGridApi)
          total += Object.keys(projectsGridApi.getFilterModel()).length
        if (departmentsGridApi)
          total += Object.keys(departmentsGridApi.getFilterModel()).length
        if (metricsGridApi)
          total += Object.keys(metricsGridApi.getFilterModel()).length
        return total
      }

      // Filter functions for specific grids
      function filterEmployeesByDept(department) {
        if (employeesGridApi) {
          employeesGridApi.setFilterModel({
            department: {
              filterType: 'text',
              type: 'equals',
              filter: department
            }
          })
        }
      }

      function filterProjectsByStatus(status) {
        if (projectsGridApi) {
          projectsGridApi.setFilterModel({
            status: { filterType: 'text', type: 'equals', filter: status }
          })
        }
      }

      function filterDepartmentsByLocation(locationPart) {
        if (departmentsGridApi) {
          departmentsGridApi.setFilterModel({
            location: {
              filterType: 'text',
              type: 'contains',
              filter: locationPart
            }
          })
        }
      }

      function filterMetricsByType(type) {
        if (metricsGridApi) {
          metricsGridApi.setFilterModel({
            type: { filterType: 'text', type: 'equals', filter: type }
          })
        }
      }

      // Clear functions
      function clearEmployeesFilters() {
        if (employeesUrlSync) employeesUrlSync.clearFilters()
      }

      function clearProjectsFilters() {
        if (projectsUrlSync) projectsUrlSync.clearFilters()
      }

      function clearDepartmentsFilters() {
        if (departmentsUrlSync) departmentsUrlSync.clearFilters()
      }

      function clearMetricsFilters() {
        if (metricsUrlSync) metricsUrlSync.clearFilters()
      }

      function clearAllGrids() {
        clearEmployeesFilters()
        clearProjectsFilters()
        clearDepartmentsFilters()
        clearMetricsFilters()
        document.getElementById('combinedUrlDisplay').textContent =
          'All filters cleared. Apply new filters to see URL generation.'
      }

      function generateCombinedUrl() {
        if (
          !employeesUrlSync ||
          !projectsUrlSync ||
          !departmentsUrlSync ||
          !metricsUrlSync
        ) {
          return
        }

        try {
          const baseUrl = window.location.origin + window.location.pathname

          // Generate URL from the first grid as base
          let combinedUrl = employeesUrlSync.generateUrl(baseUrl)

          // Parse the URL to get current parameters
          const url = new URL(combinedUrl)

          // Add parameters from other grids
          const projectsParams = projectsUrlSync.generateUrl(baseUrl)
          const projectsUrl = new URL(projectsParams)
          projectsUrl.searchParams.forEach((value, key) => {
            url.searchParams.set(key, value)
          })

          const departmentsParams = departmentsUrlSync.generateUrl(baseUrl)
          const departmentsUrl = new URL(departmentsParams)
          departmentsUrl.searchParams.forEach((value, key) => {
            url.searchParams.set(key, value)
          })

          const metricsParams = metricsUrlSync.generateUrl(baseUrl)
          const metricsUrl = new URL(metricsParams)
          metricsUrl.searchParams.forEach((value, key) => {
            url.searchParams.set(key, value)
          })

          const finalUrl = url.toString()
          document.getElementById('combinedUrlDisplay').textContent = finalUrl

          // Update browser URL
          window.history.pushState({}, '', finalUrl)

          updateStatusBar('Combined URL generated and applied to browser')
        } catch (error) {
          updateStatusBar(`Error generating combined URL: ${error.message}`)
        }
      }

      function copyUrlToClipboard() {
        const urlText =
          document.getElementById('combinedUrlDisplay').textContent
        if (
          urlText &&
          !urlText.startsWith('No filters') &&
          !urlText.startsWith('All filters')
        ) {
          navigator.clipboard
            .writeText(urlText)
            .then(() => {
              updateStatusBar('URL copied to clipboard!')
            })
            .catch(err => {
              updateStatusBar('Failed to copy URL to clipboard')
            })
        }
      }

      function applySampleFilters() {
        filterEmployeesByDept('Engineering')
        setTimeout(() => filterProjectsByStatus('Active'), 100)
        setTimeout(() => filterDepartmentsByLocation('West'), 200)
        setTimeout(() => filterMetricsByType('Revenue'), 300)
        setTimeout(() => {
          updateStatusBar('Sample filters applied to all grids')
        }, 500)
      }

      function applyUrlFiltersFromCurrentUrl() {
        const currentUrl = window.location.href

        try {
          if (employeesUrlSync) employeesUrlSync.applyFromUrl(currentUrl)
          if (projectsUrlSync) projectsUrlSync.applyFromUrl(currentUrl)
          if (departmentsUrlSync) departmentsUrlSync.applyFromUrl(currentUrl)
          if (metricsUrlSync) metricsUrlSync.applyFromUrl(currentUrl)

          updateStatusBar('Filters applied from current URL')
        } catch (error) {
          updateStatusBar(`Error applying URL filters: ${error.message}`)
        }
      }
    </script>
  </body>
</html>
